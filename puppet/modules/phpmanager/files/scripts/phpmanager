#!/bin/bash
##
# Joomlatools Composer plugin - https://github.com/joomlatools/joomla-composer
#
# @copyright	Copyright (C) 2011 - 2014 Johan Janssens and Timble CVBA. (http://www.timble.net)
# @license		MPL 2.0 <http://www.mozilla.org/MPL/2.0/>
# @link		    http://github.com/joomlatools/joomla-vagrant for the canonical source repository
##

##
# phpmanager
# A script to easily switch between different PHP versions
#
# @author   Steven Rombauts <https://github.com/stevenrombauts>
##

# Global variables:
SCRIPT_VERSION=0.1
BASENAME=$(basename $0)
SOURCE=/usr/local/src/php
TARGET=/opt/php/

VERSIONS=()
BINARIES=('php' 'pear' 'pecl' 'phar' 'phing' 'php-config' 'phpize')

# Print out usage
usage() {
    echo "phpmanager v${SCRIPT_VERSION}"
    echo "Copyright (C) 2011 - 2014 Johan Janssens and Timble CVBA. (http://www.timble.net)"
	echo "Usage: "
	echo "  $BASENAME versions              -- List all available PHP versions."
	echo "  $BASENAME available             -- Show all PHP version which have been built locally."
	echo "  $BASENAME install <version>     -- Installs selected PHP version. Builds from source if version does not exist yet. "
	echo "  $BASENAME build <version>       -- Attempts to build PHP version from source."
	echo "  $BASENAME restore               -- Put the original binaries and Apache module back in place."
	echo "  $BASENAME help                  -- Show help"
	echo ""
	echo "Configuration: "
	echo " PHP Source directory: $SOURCE"
	echo " Target directory:     $TARGET"
	exit 1
}

# Get the list of available versions
command_versions() {
    cd $SOURCE

    # Fetch the list of available PHP versions from the Git repo
    sub_getversions

    # Print out each element of the array on a separate line
    STRING=$(printf "%s\n" "${VERSIONS[@]}")

    # Display the versions in columns
    printf "%20s  %20s  %20s  %20s  %20s\n" $STRING
}

# Get the list of installed builds
command_available() {
    ls $TARGET
}

# Install PHP version
command_install() {
    VERSION=$1

    if [[ ${VERSION:0:4} != "php-" ]] ; then
        VERSION="php-${VERSION}"
    fi

    if [[ ! -d "/opt/php/$VERSION" ]] ; then
        echo -e "\033[33m${VERSION} does not exist, attempting to build ..\e[0m"

        # Fetch the list of available PHP versions from the Git repo
        sub_getversions

        in_array $VERSION
        if [[ $? != 0 ]] ; then
            echo -e "\033[31mERROR: Unknown version $VERSION\e[0m"
            exit 1
        fi

        command_build $VERSION
    fi

    # Install the binaries
    for BINARY in "${BINARIES[@]}"
    do
        # Check if we've already made backups
        if [ ! -f "/usr/bin/${BINARY}.original" ] ; then
            sudo mv "/usr/bin/${BINARY}" "/usr/bin/${BINARY}.original"
        fi

        # Now symlink the new binaries
        if [ -f "/opt/php/$VERSION/bin/$BINARY" ] ; then
            sudo ln -fs "/opt/php/$VERSION/bin/$BINARY" "/usr/bin/$BINARY"
        elif [ -f "/usr/bin/$BINARY" ] ; then
            sudo rm "/usr/bin/$BINARY"
        fi
    done

    # Setup PEAR deps
    sub_pear

    # Change the Apache module
    if [ ! -f "/usr/lib/apache2/modules/libphp5.so.original" ] ; then
        sudo cp "/usr/lib/apache2/modules/libphp5.so" "/usr/lib/apache2/modules/libphp5.so.original"
    fi

    sudo cp "/opt/php/${VERSION}/libs/libphp5.so" "/usr/lib/apache2/modules/libphp5.so"

    echo -n "Restarting Apache .. "
    sudo /etc/init.d/apache2 restart &> /dev/null

    if [ $? -ne 0 ] ; then
        echo "\033[31mFAILED\e[0m"
    else
        echo "OK"
    fi

    echo -e "Installed binaries and Apache module. PHP version is now:\n"
    php -v
}

# Build version
command_build() {
    VERSION=$1

    if [[ -z $VERSION ]] ; then
        echo -e "\033[31mERROR: No PHP version given\e[0m"
        usage
    fi;

    if [[ ${VERSION:0:4} != "php-" ]] ; then
        VERSION="php-${VERSION}"
    fi

    LOGFILE="/tmp/phpmanager-build-${VERSION}.log"
    echo -e "Starting build of ${VERSION} at $(date) .. \n\n" > "$LOGFILE"

    cd $SOURCE

    # Make sure the tag exists
    if [ ! git rev-parse "$VERSION" >/dev/null 2>&1 ] ; then
        echo -e "\033[31mERROR: $VERSION version not found\e[0m"
        usage
    fi

    # Clean-up and checkout the tag
    make clean &> /dev/null
    rm -rf configure  &> /dev/null
    ./vcsclean  &> /dev/null

    git reset --hard --quiet
    git clean -d -x -f --quiet

    echo "Checking out ${VERSION} tag"
    git checkout $VERSION  &> /dev/null

    # Setup the PATH to include legacy build tools if needed
    SHORT=$(sub_getshortversion $VERSION)
    if [[ $SHORT -le 5360 ]] ; then
        export PATH=/opt/bison-2.2/bin:/opt/flex-2.5.4/bin:$PATH
    fi

    echo "Logging to ${LOGFILE}"

    # Run configure
    ./buildconf --force  >> "$LOGFILE" 2>&1

    OPTIONS=$(sub_getoptions "$VERSION")

    CMD="./configure ${OPTIONS}"
    sub_execute "$CMD" "configure" "$LOGFILE" "Configuring makefile"

    # Start the build
    sub_execute "make" "make" "$LOGFILE" "Building ${VERSION}"

    # Backup the libphp5.so file as "make install" will overwrite it automatically
    sudo mv /usr/lib/apache2/modules/libphp5.so /usr/lib/apache2/modules/libphp5.so.bak

    # Install the new binaries and module
    sub_execute "sudo make install" "install" "$LOGFILE" "Installing ${VERSION}"

    # Now setup the php.ini files
    sub_setupini "$VERSION"

    # Store our newly built module and put the original libphp5.so module back
    sudo mkdir "/opt/php/${VERSION}/libs"

    if [[ -f "${SOURCE}/.libs/libphp5.so" ]] ; then
        sudo cp "${SOURCE}/.libs/libphp5.so" "/opt/php/${VERSION}/libs/libphp5.so"
    elif [[ -f /usr/lib/apache2/modules/libphp5.so ]] ; then
        sudo mv "/usr/lib/apache2/modules/libphp5.so" "/opt/php/${VERSION}/libs/libphp5.so"
    else
        [[ -f /usr/lib/apache2/modules/libphp5.so ]] && sudo rm /usr/lib/apache2/modules/libphp5.so
        sudo mv /usr/lib/apache2/modules/libphp5.so.bak /usr/lib/apache2/modules/libphp5.so

        echo -e "\033[31mERROR: Failed to build libphp5.so!\e[0m"
        echo "See ${LOGFILE} for more details or try again."
        exit 1
    fi

    # Put the original apache module back in place
    [[ -f /usr/lib/apache2/modules/libphp5.so ]] && sudo rm /usr/lib/apache2/modules/libphp5.so
    sudo mv /usr/lib/apache2/modules/libphp5.so.bak /usr/lib/apache2/modules/libphp5.so

    echo -e "\n${VERSION} has been built and can be found at /opt/php/${VERSION} -- happy coding!"
}

# Restore the original PHP binaries and Apache module
command_restore() {
    for BINARY in "${BINARIES[@]}"
    do
        # Remove the symlink
        if [ -L "/usr/bin/${BINARY}" ] ; then
            sudo rm "/usr/bin/${BINARY}"
        fi

        sudo cp "/usr/bin/${BINARY}.original" "/usr/bin/${BINARY}"
    done

    if [ -f "/usr/lib/apache2/modules/libphp5.so" ] ; then
        sudo rm "/usr/lib/apache2/modules/libphp5.so"
    fi

    sudo cp "/usr/lib/apache2/modules/libphp5.so.original" "/usr/lib/apache2/modules/libphp5.so"

    echo -n "Restarting Apache .. "
    sudo /etc/init.d/apache2 restart &> /dev/null

    if [ $? -ne 0 ] ; then
        echo "\033[31mFAILED\e[0m"
    else
        echo "OK"
    fi

    echo -e "Restored PHP, version is now: \n"
    php -v
}

# Run tasks that take up more time than regular commands.
# Takes the following parameters
#  - The command itself
#  - The name of the task
#  - The logfile to pipe output to
#  - A message to display next to the working indicator
sub_execute() {
    CMD=$1
    NAME=$2
    LOGFILE=$3
    MSG=$4

    $CMD >> "$LOGFILE" 2>&1 &
    PID=$!

    sub_waitinganim $PID "$MSG"

    wait $PID

    if [[ $? -ne 0 ]] ; then
        tail -n 5 "${LOGFILE}"
        echo -e "\033[31mERROR: ${NAME} failed!\e[0m"
        echo "See ${LOGFILE} for more details."
        exit 1
    fi
}

# Install PEAR libraries that are required for the box to keep working
sub_pear() {
    sudo pear channel-discover pear.phing.info &> /dev/null

    sudo pear install Console_CommandLine &> /dev/null
    sudo pear install phing/phing &> /dev/null
}

# Build the configure string
sub_getoptions() {
    VERSION=$1
    SHORT=$(sub_getshortversion $VERSION)

    # Default options :
    OPTIONS="--enable-calendar \
              --enable-cli \
              --enable-exif \
              --enable-ftp \
              --enable-intl \
              --enable-mbstring \
              --enable-soap \
              --enable-sockets \
              --enable-zip \
              --prefix=/opt/php/${VERSION} \
              --with-apxs2=/usr/bin/apxs2 \
              --with-bz2 \
              --with-config-file-scan-dir=/opt/php/${VERSION}/etc/conf.d/ \
              --with-curl \
              --with-gd --with-jpeg-dir --with-png-dir --enable-gd-native-ttf --with-freetype-dir \
              --with-iconv \
              --with-libdir=lib/x86_64-linux-gnu \
              --with-mcrypt \
              --with-pcre-regex \
              --with-readline \
              --with-xmlrpc
              --with-xsl \
              --with-zlib"

    # Build the mysql configuration string
    MYSQL=""
    if [[ "$SHORT" -lt 5213 ]] ; then
        CFG="/opt/mysql-5.1.73-linux-x86_64-glibc23/bin/mysql_config"
	    MYSQL="--with-mysql=/opt/mysql-5.1.73-linux-x86_64-glibc23 --with-pdo-mysql=${CFG}"
    elif [[ "$SHORT" -lt 5300 ]] ; then
        CFG=$(which mysql_config)
        MYSQL="--with-mysql --with-mysqli=${CFG} --with-pdo-mysql=${CFG}"
    else
        MYSQL="--with-mysql=mysqlnd --with-mysqli=mysqlnd --with-pdo-mysql=mysqlnd"
    fi
    OPTIONS="$OPTIONS $MYSQL"

    # Add some legacy options
    if [[ "$SHORT" -lt 5300 ]] ; then
        OPTIONS="$OPTIONS --enable-spl --with-mime-magic"
    fi

    echo "$OPTIONS"
}

# Copy the php.ini files
sub_setupini() {
    VERSION="$1"

    [[ ! -d "/opt/php/${VERSION}/etc/conf.d" ]] && sudo mkdir -p "/opt/php/${VERSION}/etc/conf.d"
    [[ ! -d "/opt/php/${VERSION}/lib" ]] && sudo mkdir -p "/opt/php/${VERSION}/lib"

    if [[ -f "${SOURCE}/php.ini-recommended" ]] ; then
        sudo cp "${SOURCE}/php.ini-recommended" "/opt/php/${VERSION}/lib/php.ini"
    elif [[ -f "${SOURCE}/php.ini-development" ]] ; then
        sudo cp "${SOURCE}/php.ini-development" "/opt/php/${VERSION}/lib/php.ini"
    fi

    sudo cp /etc/php5/apache2/conf.d/zzz_custom.ini "/opt/php/${VERSION}/etc/conf.d/zzz_custom.ini"
    sudo cp /etc/php5/apache2/conf.d/zzz_php.ini "/opt/php/${VERSION}/etc/conf.d/zzz_php.ini"

    sudo chown vagrant:vagrant "/opt/php/${VERSION}/lib/php.ini"
    sudo chown -R vagrant:vagrant "/opt/php/${VERSION}/etc/conf.d"
}

# Get the available PHP tags
sub_getversions() {
    cd $SOURCE

    git fetch origin --quiet &> /dev/null
    git fetch origin --tags --quiet &> /dev/null

    TAGS=()
    eval "$(git for-each-ref --shell --format='TAGS+=(%(refname))' refs/tags/)"
    for TAG in "${TAGS[@]}"; do
        # Only list PHP versions greater than or equal to 5.2
        PATTERN="refs/tags/php-[5-9]\.[2-9]"
        EXCLUDES="refs/tags/php-5\.2\.0.*"
        if [[ $TAG =~ $PATTERN ]] && ! [[ $TAG =~ $EXCLUDES ]] ; then
            VERSIONS+=(${TAG/refs\/tags\//})
        fi;
    done

    # Sort the tags
    VERSIONS=(
        $(for el in "${VERSIONS[@]}"
            do
                echo "$el"
            done | sort -t. -k 1,1n -k 2,2n -k 3,3n -k 4,4n -k 5,5n -k 6,6n -k 7,7n -k 8,8n -k 9,9n
        )
    )
}

# Convert a tag to a version string which we can use in comparisons
sub_getshortversion() {
    SHORT=$(echo $1 | sed -e 's/RC[0-9]*$//' -e 's/alpha[0-9]*$//' -e 's/beta[0-9]*$//')
    SHORT=${SHORT//[^0-9]/}

    if [[ ${#SHORT} -eq 3 ]] ; then
        SHORT="${SHORT:0:2}0${SHORT:2}"
    fi

    while [ ${#SHORT} -lt 4 ]
    do
        SHORT="${SHORT}0"
    done

    SHORT=$(printf "%04d" $SHORT)

    echo "$SHORT"
}

# Display a "loading animation" while given process is running
# From: http://stackoverflow.com/questions/12498304/using-bash-to-display-a-progress-working-indicator
sub_waitinganim() {
    PID=$1
    TEXT=$2

    SPIN='-\|/'
    i=0
    while kill -0 $PID &> /dev/null
    do
      i=$(( (i+1) % 4 ))
      printf "\r${TEXT} .. \e[1;32m${SPIN:$i:1} \e[0m\033[?25l"
      sleep .1
    done

    echo -e "\r${TEXT} .. finished\033[?25h"
}

# Check if a value exists in an array
in_array() {
    local needle=$1

    for HAY in "${VERSIONS[@]}"; do
        [[ $HAY == $needle ]] && return 0
    done
    return 1
}

# Determine the command and execute
SUBCOMMAND=$1
case $SUBCOMMAND in
    "" | "-h" | "--help" | "help")
        usage
        ;;
    *)
        shift
        command_${SUBCOMMAND} $@
        if [ $? = 127 ]; then
            echo -e "\033[31mError: '$SUBCOMMAND' is not a known command!\e[0m" >&2
            echo "Run ${BASENAME} --help for available commands."
        fi
        ;;
esac